version: '3.8'

# ðŸš€ Production Docker Compose Configuration with Nginx Reverse Proxy & sslip.io

services:
  # Nginx Reverse Proxy with SSL
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile.prod
    container_name: bharosa-nginx
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN}
    volumes:
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      - nginx_logs:/var/log/nginx
    networks:
      - bharosa_net
    depends_on:
      - backend
      - frontend
      - ai_service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Certbot for Let's Encrypt SSL
  certbot:
    image: certbot/certbot:latest
    container_name: bharosa-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - bharosa_net

  # MongoDB with Authentication
  mongodb:
    image: mongo:6.0
    container_name: bharosa-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=bharosa_kyc
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - bharosa_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Ganache Blockchain
  ganache:
    image: trufflesuite/ganache:latest
    container_name: bharosa-ganache
    command: >
      --host 0.0.0.0
      --port 8545
      --mnemonic "test test test test test test test test test test test junk"
      --networkId 1337
      --accounts 10
      --defaultBalanceEther 100
      --gasLimit 8000000
      --gasPrice 20000000000
    networks:
      - bharosa_net
    restart: unless-stopped

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bharosa-backend
    env_file:
      - .env.production
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGODB_URI=${MONGODB_URI}
      - AI_SERVICE_URL=http://ai_service:8000
      - BLOCKCHAIN_NETWORK=http://ganache:8545
      - BLOCKCHAIN_PRIVATE_KEY=${BLOCKCHAIN_PRIVATE_KEY}
      - BLOCKCHAIN_CONTRACT_ADDRESS=${BLOCKCHAIN_CONTRACT_ADDRESS}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    volumes:
      - backend_logs:/app/logs
      - backend_uploads:/app/uploads
    networks:
      - bharosa_net
    depends_on:
      mongodb:
        condition: service_healthy
      ganache:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # AI Service
  ai_service:
    build:
      context: ./ai_service
      dockerfile: Dockerfile
    container_name: bharosa-ai-service
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=production
      - LOG_LEVEL=info
    volumes:
      - ai_temp:/tmp/bharosa_ai
      - backend_uploads:/app/uploads:ro  # Share uploads folder (read-only)
    networks:
      - bharosa_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 120s

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
        - REACT_APP_API_URL=${REACT_APP_API_URL}
    container_name: bharosa-frontend
    environment:
      - NODE_ENV=production
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      - REACT_APP_ENVIRONMENT=production
    networks:
      - bharosa_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s


networks:
  bharosa_net:
    driver: bridge
    name: bharosa_net

volumes:
  mongodb_data:
    name: bharosa_mongodb_data
  mongodb_config:
    name: bharosa_mongodb_config
  backend_logs:
    name: bharosa_backend_logs
  backend_uploads:
    name: bharosa_backend_uploads
  ai_temp:
    name: bharosa_ai_temp
  nginx_logs:
    name: bharosa_nginx_logs
